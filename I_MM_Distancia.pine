// This Pine Script¬Æ code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// ¬© pmoralesdev

//@version=6
indicator("MM_Distancia", overlay=false)

//‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// üìå INPUTS
//‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

//üîπ MEDIASüîπ
emaLen = input.int(50,  "Longitud EMA", group = "üîπ MEDIAS")
smaLen = input.int(200, "Longitud SMA", group = "üîπ MEDIAS")

//üîπ UMBRALESüîπ 
lenNorm  = input.int(200, "Velas para normalizar", minval=10,   group = "üîπ UMBRALES")
umbralN  = input.float(0.6, "Umbral normalizado",  step=0.05,   group = "üîπ UMBRALES")
umbral_tend_fuerte = input.float(0.5, "Umbral Extremos",  step=0.05,   group = "üîπ UMBRALES")
umbral_tend_normal = input.float(0.3, "Umbral tendencia",  step=0.05,   group = "üîπ UMBRALES")
umbral_lateral = input.float(0.2, "Umbral lateral",  step=0.05,   group = "üîπ UMBRALES")

//üîπ CONTADORESüîπ 
lenMediaDist   = input.int(50, "Velas tendencia",           minval=1, group = "üîπ CONTADORES")
lenSignWindow  = input.int(50, "Ventana cambios de signo",  minval=2, group = "üîπ CONTADORES")
maxSignChanges = input.int(3,  "M√°x cambios de signo",      minval=0, group = "üîπ CONTADORES")

//üîπ VELOCIDADüîπ 
fastLen           = input.int(5,  "EMA MACD r√°pida",  minval=1, group = "üîπ VELOCIDAD")
slowLen           = input.int(20, "EMA MACD lenta",   minval=1, group = "üîπ VELOCIDAD")
strongMomentumThr = input.float(0.35, "Umbral velocidad", step=0.05, group = "üîπ VELOCIDAD")

//üîπ IMPULSOüîπ
exitImpThr      = input.float(0.25, "Fuerza impulso",      step=0.05, group = "üîπ IMPULSO")
exitConfirmBars = input.int(3,      "Velas confirmaci√≥n",  minval=1,  group = "üîπ IMPULSO")

//‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// üìå INDICADORES
//‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

//üîπ Medias M√≥vilesüîπ 
ema  = ta.ema(close, emaLen)
sma = ta.sma(close, smaLen)
distPct = (ema - sma) / sma * 100

//üîπ Umbral Din√°mico-Normalizadoüîπ 
maxAbsDist = ta.highest(math.abs(distPct), lenNorm)
distNorm = maxAbsDist != 0.0 ? distPct / maxAbsDist : 0.0
distNormMedia = ta.sma(distNorm, lenMediaDist)
condUmbral = math.abs(distNorm) > umbralN

//‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// üìå ESTABILIDAD DE SIGNO
//‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
signNow  = distNormMedia > 0 ? 1 : distNormMedia < 0 ? -1 : 0
signPrev = distNormMedia[1] > 0 ? 1 : distNormMedia[1] < 0 ? -1 : 0

signChanged = signNow != signPrev

// Contamos cambios de signo como serie float
signChangeSeries = signChanged ? 1.0 : 0.0

// n¬∫ de cambios de signo en la ventana
signChangesLastN = math.sum(signChangeSeries, lenSignWindow)

// tendencia ‚Äúestable‚Äù si hay pocos cambios de signo
tendEstable = signChangesLastN <= maxSignChanges

//‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// üìå VELOCIDAD
//‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

distFast = ta.ema(distNorm, fastLen)  
distSlow = ta.ema(distNorm, slowLen)  

//‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// üìå SEM√ÅFORO
//‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

absMedia = math.abs(distNormMedia)
absNorm  = math.abs(distNorm)

//üîπ Tendenciaüîπ

// 1. V√≠a cl√°sica
tendFuerte_clasica = absMedia >= umbral_tend_fuerte and tendEstable
tendNormal_clasica = absMedia >= umbral_tend_normal and absMedia < umbral_tend_fuerte and tendEstable

// 2. V√≠a r√°pida
tendNormal_rapida = (distFast > distSlow) and tendEstable and absNorm >= umbral_lateral and absMedia < umbral_tend_normal
tendFuerte_rapida = (distFast > distSlow) and tendEstable and absNorm >= strongMomentumThr 

// 3. Combinamos ambas v√≠as
esTendFuerte_preExit = tendFuerte_clasica or tendFuerte_rapida
esTendNormal_preExit = tendNormal_clasica or tendNormal_rapida

// 4. Salida r√°pida de tendencia
exitRaw = (distFast < distSlow) and (absNorm < exitImpThr)
exitCount     = math.sum(exitRaw ? 1.0 : 0.0, exitConfirmBars)
salidaRapida  = exitCount == exitConfirmBars

//üîπ Condicionalesüîπ
esTendFuerte = esTendFuerte_preExit and not salidaRapida
esTendNormal = esTendNormal_preExit and not salidaRapida
esLateral = absMedia < umbral_lateral
esTransicion = not esTendFuerte and not esTendNormal and not esLateral

//‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// üìå PLOTS
//‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

//üîπ Distanciasüîπ
plot(distNorm, title="Distancia normalizada", color=color.new(color.yellow, 0), linewidth=2)
plot(distNormMedia, title="Sem√°foro", color=color.new(color.blue, 0), linewidth=2)

//üîπ L√≠neas de referenciaüîπ
hline(0,  "0",  color=color.new(color.white, 70))
hline(1,  "+1", color=color.new(color.gray, 70))
hline(-1, "-1", color=color.new(color.gray, 70))

//üîπ Color de fondoüîπ
colorFondo =
     esTendFuerte ? color.new(color.green, 85) :
     esTendNormal ? color.new(color.blue, 85) :
     esTransicion ? color.new(color.orange, 85) :
     esLateral    ? color.new(color.red, 85) :
     na

bgcolor(colorFondo)

//‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// üìå PARAMETRIZACI√ìN
//‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

//üîπ DAXüîπ
//emaLen = 50
//smaLen = 200
//lenNorm  = 500
//umbralN  = 0.6
//lenMediaDist  = 120 
//lenSignWindow = 150
//maxSignChanges = 6
//fastLen = 4
// slowLen = 18
//strongMomentumThr = 0.4
//exitImpThr = 0.25
//exitConfirmBars = 4 

//üîπ OROüîπ
//emaLen = 50
//smaLen = 200
//lenNorm  = 700
//umbralN  = 0.65
//lenMediaDist   = 150 
//lenSignWindow  = 200
//maxSignChanges = 5
//fastLen = 5
// slowLen = 22
//strongMomentumThr = 0.45
//exitImpThr = 0.3
//exitConfirmBars = 5 

//üîπ NASDAQüîπ
//emaLen = 50
//smaLen = 200
//lenNorm  = 600 
//umbralN  = 0.7
//lenMediaDist   = 90 
//lenSignWindow  = 120
//maxSignChanges = 8
//fastLen = 3
// slowLen = 15
//strongMomentumThr = 0.35
//exitImpThr = 0.22
//exitConfirmBars = 3 