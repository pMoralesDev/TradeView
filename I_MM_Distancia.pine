// This Pine ScriptÂ® code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// Â© pmoralesdev

//@version=6
indicator("MM_Distancia", overlay=false)

//â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ðŸ“Œ INPUTS
//â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

emaLen = input.int(50,  "Longitud EMA")
smaLen = input.int(200, "Longitud SMA")

//ðŸ”¹ UMBRALESðŸ”¹ 
lenNorm     = input.int(200, "Velas para normalizar", minval=10)
umbralN  = input.float(0.6, "Umbral normalizado", step=0.05)

//ðŸ”¹ CONTADORESðŸ”¹ 
lenMediaDist = input.int(50, "Velas tendencia", minval=1)
lenSignWindow  = input.int(50, "Ventana cambios de signo", minval=2)
maxSignChanges = input.int(3,  "MÃ¡x cambios de signo permitidos", minval=0)

//â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ðŸ“Œ INDICADORES
//â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

//ðŸ”¹ Medias MÃ³vilesðŸ”¹ 
ema  = ta.ema(close, emaLen)
sma = ta.sma(close, smaLen)
distPct = (ema - sma) / sma * 100

//ðŸ”¹ Umbral DinÃ¡micoðŸ”¹ 
// Max abs de la distancia en las Ãºltimas lenNorm velas
maxAbsDist = ta.highest(math.abs(distPct), lenNorm)
// Distancia normalizada a [-1, 1]
distNorm = maxAbsDist != 0.0 ? distPct / maxAbsDist : 0.0
// media de distNorm para suavizar el rÃ©gimen
distNormMedia = ta.sma(distNorm, lenMediaDist)
// CondiciÃ³n de umbral (en unidades normalizadas)
condUmbral = math.abs(distNorm) > umbralN

//â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ðŸ“Œ ESTABILIDAD DE SIGNO
//â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
signNow  = distNormMedia > 0 ? 1 : distNormMedia < 0 ? -1 : 0
signPrev = distNormMedia[1] > 0 ? 1 : distNormMedia[1] < 0 ? -1 : 0

signChanged = signNow != signPrev

// Contamos cambios de signo como serie float
signChangeSeries = signChanged ? 1.0 : 0.0

// nÂº de cambios de signo en la ventana
signChangesLastN = ta.sma(signChangeSeries, lenSignWindow) * lenSignWindow

// tendencia â€œestableâ€ si hay pocos cambios de signo
tendEstable = signChangesLastN <= maxSignChanges

//â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ðŸ“Œ SEMÃFORO
//â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

// Umbrales que hemos fijado
umbral_tend_fuerte = 0.50
umbral_tend_normal = 0.30
umbral_lateral     = 0.20

absMedia = math.abs(distNormMedia)

// Solo consideramos tendencia fuerte/normal si es estable
esTendFuerte = absMedia >= umbral_tend_fuerte and tendEstable
esTendNormal = absMedia >= umbral_tend_normal and absMedia < umbral_tend_fuerte and tendEstable
esTransicion = absMedia >= umbral_lateral and absMedia < umbral_tend_fuerte and not tendEstable
esLateral    = absMedia <  umbral_lateral

// Color del fondo segÃºn rÃ©gimen
colorFondo =
     esTendFuerte ? color.new(color.green, 85) :
     esTendNormal ? color.new(color.blue, 85) :
     esTransicion ? color.new(color.orange, 85) :
     esLateral    ? color.new(color.red, 85) :
     na

bgcolor(colorFondo)

//â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ðŸ“Œ PLOTS
//â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

plot(distNorm, title="Distancia normalizada", color=color.new(color.orange, 0), linewidth=2)
plot(distNormMedia, title="SemÃ¡foro", color=color.new(color.teal, 0), linewidth=2)

//------LÃ­neas de referencia------
hline(0,  "0",  color=color.new(color.white, 70))
hline(1,  "+1", color=color.new(color.gray, 70))
hline(-1, "-1", color=color.new(color.gray, 70))

//â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ðŸ“Œ AnÃ¡lisis tÃ©cnico
//â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

//Este indicador nos permite detectar:
//   Tendencias fuertes
//   Desacoples grandes entre medias
//   Evitar seÃ±ales en zonas laterales
//   Confirmar impulsos