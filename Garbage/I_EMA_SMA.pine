//@version=6
// This Pine Script¬Æ code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// ¬© pmoralesdev

indicator("Medias m√≥viles", overlay=true)

// Inputs
emaLen = input.int(50,  "Longitud EMA")
smaLen = input.int(200, "Longitud SMA")

// Filtro de pendiente y distancia (se reutiliza para el HTF)
slopeLen      = input.int(5,    "Velas para pendiente SMA200", minval=1)
slopeThrPct   = input.float(0.02, "M√≠n pendiente SMA200 (%)", step=0.01)
distThrPct    = input.float(0.2, "Distancia m√≠n EMA_SMA (%)", step=0.01)
mostrarLateral= input.bool(true, "Resaltar zona lateral")

// Timeframe para pintar el fondo (HTF)
higherTF = input.timeframe("15", "Timeframe fondo EMA/SMA (HTF)")

// Activar / desactivar alertas
alertLongOn  = input.bool(true, "Activar alerta largos")
alertShortOn = input.bool(true, "Activar alerta cortos")

//-------------------------
// Medias en timeframe ACTUAL (se√±ales, alertas, etc.)
//-------------------------
ema50  = ta.ema(close, emaLen)
sma200 = ta.sma(close, smaLen)

plot(ema50,  title="EMA 50",  color=color.yellow, linewidth=1)
plot(sma200, title="SMA 200", color=color.blue,   linewidth=1)

// Tendencia b√°sica en timeframe actual
alcista = ema50 > sma200
bajista = ema50 < sma200

//-------------------------
// Medias en timeframe SUPERIOR (para el FONDO)
//-------------------------
ema50_HTF  = request.security(syminfo.tickerid, higherTF, ta.ema(close, emaLen))
sma200_HTF = request.security(syminfo.tickerid, higherTF, ta.sma(close, smaLen))

// Estado: cruces pendientes de confirmar
var bool pendingLong  = false
var bool pendingShort = false

// Estado de posici√≥n abierta
var bool inLong  = false
var bool inShort = false

//-------------------------
// FONDO basado SIEMPRE en HTF
//-------------------------
// Calculamos TODO en 15m y lo traemos ya hecho

// 1) Direcci√≥n (alcista / bajista) en HTF
//htfAlcista = request.security( syminfo.tickerid, higherTF, ta.ema(close, emaLen) > ta.sma(close, smaLen) )
//htfBajista = request.security( syminfo.tickerid, higherTF, ta.ema(close, emaLen) < ta.sma(close, smaLen) )

// 2) Pendiente en HTF (se calcula all√≠)
//slopePctHTF = request.security( syminfo.tickerid, higherTF, math.abs(ta.sma(close, smaLen) - ta.sma(close, smaLen)[slopeLen]) / close * 100.0)

// 3) Distancia EMA‚ÄìSMA en HTF (se calcula all√≠)
//distPctHTF = request.security( syminfo.tickerid, higherTF, math.abs(ta.ema(close, emaLen) - ta.sma(close, smaLen)) / close * 100.0)

// 4) Tendencial vs lateral en HTF
//trendingHTF = (slopePctHTF > slopeThrPct) and (distPctHTF > distThrPct)

// 5) Color del fondo (HTF limpio, sin rayas)
//trendColorHTF = trendingHTF ? (htfAlcista ? color.new(color.green, 50) : htfBajista ? color.new(color.red, 50) : na) : (mostrarLateral ? color.new(color.black, 92) : na)

//bgcolor(trendColorHTF)

// Cruces
crossUp   = ta.crossover(ema50, sma200)
crossDown = ta.crossunder(ema50, sma200)

// Take Profit: cuando se produce el cruce contrario con una posici√≥n abierta
tpLong  = inLong  and crossDown 
tpShort = inShort and crossUp 

// Distancia actual entre medias (en %)
distPct2 = math.abs(ema50 - sma200) / close * 100.0

// Guardar el precio del cruce para usarlo como Stop Loss
// (valor de las medias en el momento del cruce)
var float longSlPrice  = na
var float shortSlPrice = na

// Cuando hay un cruce, marcamos pendiente y guardamos el precio
if crossUp
    pendingLong  := true
    pendingShort := false
    longSlPrice  := ema50

if crossDown
    pendingShort := true
    pendingLong  := false
    shortSlPrice := ema50

// Cruces "v√°lidos": s√≥lo cuando hay tendencia
longSignal  =  pendingLong  and ema50 > sma200 and distPct2 >= distThrPct
shortSignal = pendingShort and ema50 < sma200 and distPct2 >= distThrPct

// Una vez disparada la se√±al, limpiamos el pendiente
if longSignal
    pendingLong := false
    inLong      := true
    inShort     := false

if shortSignal
    pendingShort := false
    inShort      := true
    inLong       := false

// Se√±ales sin saltos de l√≠nea
plotshape(longSignal,   title="Cruce alcista", style=shape.triangleup,   location=location.belowbar, color=color.green, size=size.normal)
plotshape(shortSignal, title="Cruce bajista", style=shape.triangledown, location=location.abovebar,  color=color.red,   size=size.normal)

//Se√±ales de cierre de posici√≥n
plotshape(tpLong,  title="TP largo",  style=shape.circle, location=location.abovebar,  color=color.new(color.green, 0), size=size.tiny)
plotshape(tpShort, title="TP corto", style=shape.circle, location=location.belowbar, color=color.new(color.red,   0), size=size.tiny)


//-------------------------
// ALERTAS
//-------------------------

//Con Stop Loos
if longSignal and alertLongOn
    slTxt = str.tostring(longSlPrice, format.mintick)
    sym   = syminfo.ticker
    tf    = timeframe.period
    msg   = sym + "üìà COMPRA-" +"\n" + "SL: " + slTxt
    alert(msg, alert.freq_once_per_bar_close)

if shortSignal and alertShortOn
    slTxt = str.tostring(shortSlPrice, format.mintick)
    sym   = syminfo.ticker
    tf    = timeframe.period
    msg   = sym +"üìâ VENTA-" +"\n" + "SL: " + slTxt
    alert(msg, alert.freq_once_per_bar_close)

// ALERTAS TAKE PROFIT
if tpLong
    sym = syminfo.ticker
    tf  = timeframe.period
    msg = "üéØ TAKE PROFIT - " + sym
    alert(msg, alert.freq_once_per_bar_close)
    inLong := false

if tpShort
    sym = syminfo.ticker
    tf  = timeframe.period
    msg = "üéØ TAKE PROFIT - " + sym
    alert(msg, alert.freq_once_per_bar_close)
    inShort := false 

// Alerta cuando se dispare la se√±al de largos
alertcondition(longSignal and alertLongOn, title   = "Se√±al LARGA - Medias m√≥viles", message = "Se√±al LARGA: EMA50 por encima SMA200, en zona tendencial.")

// Alerta cuando se dispare la se√±al de cortos
alertcondition(shortSignal and alertShortOn, title   = "Se√±al CORTA - Medias m√≥viles", message = "Se√±al CORTA: EMA50 por debajo SMA200, en zona tendencial.")