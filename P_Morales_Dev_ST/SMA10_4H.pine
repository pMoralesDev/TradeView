// This Pine ScriptÂ® code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// Â© pmoralesdev

//@version=6
strategy("SMA10_4H + Trend Filter",
     overlay = true,
     initial_capital = 100000,
     currency = currency.EUR,
     default_qty_type = strategy.percent_of_equity,
     default_qty_value = 33,
     pyramiding = 0,
     slippage = 1,
     process_orders_on_close = true,
     fill_orders_on_standard_ohlc = true,
     calc_on_order_fills = false,      // ðŸ‘ˆ clave si quieres decisiones solo al cierre
     calc_on_every_tick = false,
     use_bar_magnifier = true,
     margin_long = 100,
     margin_short = 100,
     commission_type = strategy.commission.percent,
     commission_value = 0.05
)

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ðŸ“Œ INPUTS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
group_ma = "ðŸ”¹ MEDIAS"
lenSMA   = input.int(10, "Longitud SMA (seÃ±al)", minval=1, group=group_ma)

group_filter = "ðŸ§­ Filtro de tendencia"
useTrendFilter = input.bool(true, "Activar filtro SMA mayor", group=group_filter)
lenTrendSMA    = input.int(200, "Longitud SMA filtro", minval=2, group=group_filter)
plotTrendSMA   = input.bool(true, "Plot SMA filtro", group=group_filter)

group_risk = "ðŸ›¡ï¸ Riesgo"
exitOnOpposite = input.bool(true, "Cerrar por cruce contrario", group=group_risk)

group_app = "ðŸ”¹ Appearance"
white = input.color(#FFFFFF, "SMA seÃ±al", group=group_app)
blue  = input.color(#00BFFF, "SMA filtro", group=group_app)

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ðŸ“ˆ CORE
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
sma10   = ta.sma(close, lenSMA)
trendMA = ta.sma(close, lenTrendSMA)

// SeÃ±ales SOLO al cierre
bullSignal = barstate.isconfirmed and ta.crossover(close, sma10)
bearSignal = barstate.isconfirmed and ta.crossunder(close, sma10)

// CondiciÃ³n de tendencia
trendLongOk  = not useTrendFilter or close > trendMA
trendShortOk = not useTrendFilter or close < trendMA

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ðŸ§· STOP/TP FIJOS AL ENTRAR + candado 1 entrada por vela
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
var float longSL  = na
var float shortSL = na
var float longTP  = na
var float shortTP = na
var int   lastEntryBar = na

canEnterThisBar = barstate.isconfirmed and (na(lastEntryBar) or lastEntryBar != bar_index)

// Entradas
if canEnterThisBar and bullSignal and trendLongOk and strategy.position_size <= 0
    longSL := low[10]
    longTP := close + 2 * (close - longSL)
    strategy.entry("Long", strategy.long)
    lastEntryBar := bar_index

if canEnterThisBar and bearSignal and trendShortOk and strategy.position_size >= 0
    shortSL := high[10]
    shortTP := close - 2 * (shortSL - close)
    strategy.entry("Short", strategy.short)
    lastEntryBar := bar_index

// Salidas
takeProfitEnabled = not exitOnOpposite
strategy.exit("Long_exit",  from_entry="Long",  stop=longSL,  limit=takeProfitEnabled ? longTP : na)
strategy.exit("Short_exit", from_entry="Short", stop=shortSL, limit=takeProfitEnabled ? shortTP : na)

// Cierre por cruce contrario (al cierre)
if exitOnOpposite and bearSignal
    strategy.close("Long")
if exitOnOpposite and bullSignal
    strategy.close("Short")

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ðŸŽ¨ PLOTS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
plot(sma10, title="SMA seÃ±al", color=color.new(white, 0), linewidth=1)
plot(plotTrendSMA ? trendMA : na, title="SMA filtro", color=color.new(blue, 0), linewidth=2)
