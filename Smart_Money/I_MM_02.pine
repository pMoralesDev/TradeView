// This Pine Scriptâ„¢ code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// Â© AlgoAlpha + mod by you

//@version=6
indicator("I_SM_02", overlay=true, max_labels_count=500)


// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ðŸ“Œ INPUTS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
groupMain = "Main Calculations"
length = input.int(70, "Length", tooltip="Look-back window for Zero-Lag EMA", group=groupMain)
mult   = input.float(1.2, "Band Multiplier", tooltip="Thickness of bands (higher = less noisy)", group=groupMain)

groupTF = "Extra Timeframes"
t1 = input.timeframe("1",  "Time frame 1", group=groupTF)
t2 = input.timeframe("3",  "Time frame 2", group=groupTF)
t3 = input.timeframe("5",  "Time frame 3", group=groupTF)
t4 = input.timeframe("15", "Time frame 4", group=groupTF)
t5 = input.timeframe("60", "Time frame 5", group=groupTF)

groupApp = "Appearance"
green = input.color(#00ffbb, "Bullish Color", group=groupApp)
red   = input.color(#ff1100, "Bearish Color", group=groupApp)

groupCtrl = "Control / Debug"
showBands      = input.bool(true,  "Show bands & fill", group=groupCtrl)
showAlignMarks = input.bool(true,  "Draw ALIGN marks", group=groupCtrl)
showEntryMarks = input.bool(true,  "Draw ENTRY marks", group=groupCtrl)
showBgMode     = input.bool(true,  "Background (aligned mode)", group=groupCtrl)
showTable      = input.bool(true,  "Status table (top-right)", group=groupCtrl)
showLastLabel  = input.bool(false, "Last-bar status label", group=groupCtrl)

groupAlerts = "Alerts via alert()"
alertOnAlign = input.bool(true,  "Alert when 5TF aligns", group=groupAlerts)
alertOnEntry = input.bool(false, "Alert on ENTRY (while aligned)", group=groupAlerts)

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ðŸ“ˆ CORE CALCS: ZLEMA + VOL BANDS + TREND STATE
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
src = close
lag = math.floor((length - 1) / 2)

zlema = ta.ema(src + (src - src[lag]), length)
volatility = ta.highest(ta.atr(length), length * 3) * mult

var int trend = 0
if ta.crossover(close, zlema + volatility)
    trend := 1
if ta.crossunder(close, zlema - volatility)
    trend := -1

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ðŸ§± PLOTS: ZLEMA + BANDS (NO local scope)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
zlemaColor = trend == 1 ? color.new(green, 70) : color.new(red, 70)
m = plot(zlema, title="Zero Lag Basis", linewidth=2, color=zlemaColor)

upperSeries = (showBands and trend == -1) ? (zlema + volatility) : na
lowerSeries = (showBands and trend == 1)  ? (zlema - volatility) : na

upper = plot(upperSeries, title="Upper Deviation Band", style=plot.style_linebr, color=color.new(red, 90))
lower = plot(lowerSeries, title="Lower Deviation Band", style=plot.style_linebr, color=color.new(green, 90))

// fill() tambiÃ©n debe estar en scope global; si le pasas na no dibuja
fill(m, upper, (open + close) / 2, showBands ? (zlema + volatility) : na, color.new(red, 90), color.new(red, 70))
fill(m, lower, (open + close) / 2, showBands ? (zlema - volatility) : na, color.new(green, 90), color.new(green, 70))

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ðŸ§­ MTF: TREND IN 5 TFs
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
s1 = request.security(syminfo.tickerid, t1, trend, barmerge.gaps_off, barmerge.lookahead_off)
s2 = request.security(syminfo.tickerid, t2, trend, barmerge.gaps_off, barmerge.lookahead_off)
s3 = request.security(syminfo.tickerid, t3, trend, barmerge.gaps_off, barmerge.lookahead_off)
s4 = request.security(syminfo.tickerid, t4, trend, barmerge.gaps_off, barmerge.lookahead_off)
s5 = request.security(syminfo.tickerid, t5, trend, barmerge.gaps_off, barmerge.lookahead_off)

// AlineaciÃ³n
alignedBull = (s1 == 1) and (s2 == 1) and (s3 == 1) and (s4 == 1) and (s5 == 1)
alignedBear = (s1 == -1) and (s2 == -1) and (s3 == -1) and (s4 == -1) and (s5 == -1)

// Evitar estado inicial 0 (si aparece)
allDefined = (s1 != 0) and (s2 != 0) and (s3 != 0) and (s4 != 0) and (s5 != 0)

// Edge triggers (solo cuando â€œse activaâ€)
bullAlignTrig = alignedBull and not alignedBull[1] and allDefined
bearAlignTrig = alignedBear and not alignedBear[1] and allDefined

// Entradas (timing) dentro del modo alineado (pullback a ZLEMA)
bullEntry = ta.crossover(close, zlema) and alignedBull and allDefined
bearEntry = ta.crossunder(close, zlema) and alignedBear and allDefined

// Evitar repeticiÃ³n en velas consecutivas
bullEntryTrig = bullEntry and not bullEntry[1]
bearEntryTrig = bearEntry and not bearEntry[1]

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ðŸŽ¯ DIBUJO: ALIGN (grande) + ENTRY (pequeÃ±o) (NO local scope)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
bullAlignY = (showAlignMarks and bullAlignTrig) ? (zlema - volatility) : na
bearAlignY = (showAlignMarks and bearAlignTrig) ? (zlema + volatility) : na

plotshape(bullAlignY, title="âœ… 5TF Bullish Align",
     style=shape.labelup, location=location.absolute,
     color=green, text="ALIGN â–²", textcolor=chart.fg_color, size=size.small)

plotshape(bearAlignY, title="âœ… 5TF Bearish Align",
     style=shape.labeldown, location=location.absolute,
     color=red, text="ALIGN â–¼", textcolor=chart.fg_color, size=size.small)

bullEntryY = (showEntryMarks and bullEntryTrig) ? (zlema - volatility * 1.5) : na
bearEntryY = (showEntryMarks and bearEntryTrig) ? (zlema + volatility * 1.5) : na

plotchar(bullEntryY, title="â–² Entry (Bull aligned)",
     char="â–²", location=location.absolute, color=green, size=size.tiny)

plotchar(bearEntryY, title="â–¼ Entry (Bear aligned)",
     char="â–¼", location=location.absolute, color=red, size=size.tiny)

// Fondo â€œmodoâ€ (NO local scope)
bgMode = showBgMode ? (alignedBull ? color.new(green, 92) : alignedBear ? color.new(red, 92) : na) : na
bgcolor(bgMode)

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ðŸ”” ALERTS (SIN alertcondition): alert()
// Crea la alerta en TV con: "Any alert() function call"
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
sym = syminfo.ticker

if alertOnAlign and bullAlignTrig
    msg = sym + " âœ…ðŸ“ˆ 5TF ALINEADOS (COMPRA)\n" +
          "TFs: " + t1 + "," + t2 + "," + t3 + "," + t4 + "," + t5
    alert(msg, alert.freq_once_per_bar_close)

if alertOnAlign and bearAlignTrig
    msg = sym + " âœ…ðŸ“‰ 5TF ALINEADOS (VENTA)\n" +
          "TFs: " + t1 + "," + t2 + "," + t3 + "," + t4 + "," + t5
    alert(msg, alert.freq_once_per_bar_close)

if alertOnEntry and bullEntryTrig
    msg = sym + " â–²ðŸ“ˆ ENTRY LONG (5TF alineados)\n" +
          "Trigger: cruce close > ZLEMA"
    alert(msg, alert.freq_once_per_bar_close)

if alertOnEntry and bearEntryTrig
    msg = sym + " â–¼ðŸ“‰ ENTRY SHORT (5TF alineados)\n" +
          "Trigger: cruce close < ZLEMA"
    alert(msg, alert.freq_once_per_bar_close)

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ðŸ§© â€œMÃS CONTROLâ€: tabla + label de estado
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
f_state(_s) =>
    _s == 1 ? "Bull" : _s == -1 ? "Bear" : "0"

f_bg(_s) =>
    _s == 1 ? color.new(green, 70) : _s == -1 ? color.new(red, 70) : color.new(color.gray, 85)

var table data_table = na
if showTable and barstate.islast
    if na(data_table)
        data_table := table.new(position=position.top_right, columns=3, rows=8,
            bgcolor=chart.bg_color, border_width=1, border_color=chart.fg_color,
            frame_color=chart.fg_color, frame_width=1)

    table.cell(data_table, 0, 0, "Timeframe", text_color=chart.fg_color, text_halign=text.align_center)
    table.cell(data_table, 1, 0, "Trend",     text_color=chart.fg_color, text_halign=text.align_center)
    table.cell(data_table, 2, 0, "Aligned",   text_color=chart.fg_color, text_halign=text.align_center)

    table.cell(data_table, 0, 1, t1, text_color=chart.fg_color, text_halign=text.align_center)
    table.cell(data_table, 1, 1, f_state(s1), text_color=chart.fg_color, bgcolor=f_bg(s1), text_halign=text.align_center)
    table.cell(data_table, 2, 1, alignedBull ? "BUY" : alignedBear ? "SELL" : "-", text_color=chart.fg_color, text_halign=text.align_center)

    table.cell(data_table, 0, 2, t2, text_color=chart.fg_color, text_halign=text.align_center)
    table.cell(data_table, 1, 2, f_state(s2), text_color=chart.fg_color, bgcolor=f_bg(s2), text_halign=text.align_center)
    table.cell(data_table, 2, 2, alignedBull ? "BUY" : alignedBear ? "SELL" : "-", text_color=chart.fg_color, text_halign=text.align_center)

    table.cell(data_table, 0, 3, t3, text_color=chart.fg_color, text_halign=text.align_center)
    table.cell(data_table, 1, 3, f_state(s3), text_color=chart.fg_color, bgcolor=f_bg(s3), text_halign=text.align_center)
    table.cell(data_table, 2, 3, alignedBull ? "BUY" : alignedBear ? "SELL" : "-", text_color=chart.fg_color, text_halign=text.align_center)

    table.cell(data_table, 0, 4, t4, text_color=chart.fg_color, text_halign=text.align_center)
    table.cell(data_table, 1, 4, f_state(s4), text_color=chart.fg_color, bgcolor=f_bg(s4), text_halign=text.align_center)
    table.cell(data_table, 2, 4, alignedBull ? "BUY" : alignedBear ? "SELL" : "-", text_color=chart.fg_color, text_halign=text.align_center)

    table.cell(data_table, 0, 5, t5, text_color=chart.fg_color, text_halign=text.align_center)
    table.cell(data_table, 1, 5, f_state(s5), text_color=chart.fg_color, bgcolor=f_bg(s5), text_halign=text.align_center)
    table.cell(data_table, 2, 5, alignedBull ? "BUY" : alignedBear ? "SELL" : "-", text_color=chart.fg_color, text_halign=text.align_center)

    modeTxt = alignedBull ? "âœ… BUY (5/5)" : alignedBear ? "âœ… SELL (5/5)" : "â€” not aligned â€”"
    modeBg  = alignedBull ? color.new(green, 80) : alignedBear ? color.new(red, 80) : color.new(color.gray, 90)
    table.cell(data_table, 0, 6, "MODE", text_color=chart.fg_color, text_halign=text.align_center)
    table.cell(data_table, 1, 6, modeTxt, text_color=chart.fg_color, bgcolor=modeBg, text_halign=text.align_center)
    table.cell(data_table, 2, 6, "", text_color=chart.fg_color, bgcolor=modeBg)

    lastSig = bullAlignTrig ? "ALIGN BUY" : bearAlignTrig ? "ALIGN SELL" : bullEntryTrig ? "ENTRY LONG" : bearEntryTrig ? "ENTRY SHORT" : "-"
    table.cell(data_table, 0, 7, "LAST", text_color=chart.fg_color, text_halign=text.align_center)
    table.cell(data_table, 1, 7, lastSig, text_color=chart.fg_color, text_halign=text.align_center)
    table.cell(data_table, 2, 7, "", text_color=chart.fg_color)

// Label de estado en la Ãºltima vela (opcional)
var label lastLbl = na
if showLastLabel and barstate.islast
    txt = "MTF: " +
          t1 + "=" + f_state(s1) + " | " +
          t2 + "=" + f_state(s2) + " | " +
          t3 + "=" + f_state(s3) + " | " +
          t4 + "=" + f_state(s4) + " | " +
          t5 + "=" + f_state(s5) + "\n" +
          "MODE: " + (alignedBull ? "BUY" : alignedBear ? "SELL" : "NOT ALIGNED")
    if not na(lastLbl)
        label.delete(lastLbl)
    lastLbl := label.new(bar_index, high, txt, style=label.style_label_down,
        textcolor=chart.fg_color, color=color.new(color.black, 0))