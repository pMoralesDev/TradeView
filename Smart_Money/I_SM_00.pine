// This Pine ScriptÂ® code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// Â© pmoralesdev

//@version=6
indicator("I_SM_00", overlay=true, max_labels_count=500, max_lines_count=500, max_boxes_count=50)

//â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ğŸ“Œ INPUTS
//â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
group_main = "ğŸ“Œ ParÃ¡metros"
len        = input.int(24, "N velas (lookback)", minval=2, group=group_main)

group_zone = "ğŸ“¦ Zona (grosor)"
zoneType   = input.string("ATR", "Tipo de grosor", options=["ATR", "%"], group=group_zone)
zoneValue  = input.float(0.5, "Grosor (ATR o %)", step=0.1, group=group_zone)
atrLen     = input.int(14, "ATR length (si usas ATR)", minval=1, group=group_zone)

group_vis  = "ğŸ¨ Visual"
showZones  = input.bool(true, "Mostrar zonas", group=group_vis)
showEQ     = input.bool(true, "Mostrar EQ", group=group_vis)
showEqLbl  = input.bool(true, "Etiqueta EQ", group=group_vis)

group_alert = "ğŸ”” Alertas"
alertOnNew  = input.bool(true,  "Alertar cuando se crea un nuevo nivel (nuevo HH/LL)", group=group_alert)
alertOnHit  = input.bool(false, "Alertar cuando el precio toca el nivel", group=group_alert)
touchTolPc  = input.float(0.02, "Tolerancia toque (%)", step=0.01, group=group_alert)

//â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ğŸ“ˆ MEDIAS MÃ“VILES
//â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

ema25  = ta.ema(close, 25)
ema50  = ta.ema(close, 50)
sma100 = ta.sma(close, 100)
sma200 = ta.sma(close, 200)

plot(ema25,  title="EMA 25",  color=color.white,  linewidth=1)
plot(sma100, title="SMA 100", color=color.purple, linewidth=1)
plot(ema50,  title="EMA 50",  color=color.yellow, linewidth=3)
plot(sma200, title="SMA 200", color=color.blue,   linewidth=3)

//â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ğŸ“Œ CÃLCULOS
//â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
hh = ta.highest(high, len)
ll = ta.lowest(low, len)
eq = (hh + ll) / 2.0

atr   = ta.atr(atrLen)
zoneH = zoneType == "ATR" ? (atr * zoneValue) : (close * (zoneValue / 100.0))

// Ventana EXACTA de N velas (sin extender)
leftX  = bar_index - (len - 1)
rightX = bar_index
ext    = extend.none

//â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ğŸ“Œ DIBUJO: ZONAS (cajas)
//â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
var box topBox = na
var box botBox = na

if showZones
    // Superior (roja): HH â†’ HH - zoneH
    if na(topBox)
        topBox := box.new(leftX, hh, rightX, hh - zoneH,
            bgcolor=color.new(color.red, 80),
            border_color=color.new(color.red, 0),
            extend=ext)
    else
        box.set_left(topBox, leftX)
        box.set_right(topBox, rightX)
        box.set_top(topBox, hh)
        box.set_bottom(topBox, hh - zoneH)
        box.set_extend(topBox, ext)

    // Inferior (verde): LL + zoneH â†’ LL
    if na(botBox)
        botBox := box.new(leftX, ll + zoneH, rightX, ll,
            bgcolor=color.new(color.lime, 80),
            border_color=color.new(color.lime, 0),
            extend=ext)
    else
        box.set_left(botBox, leftX)
        box.set_right(botBox, rightX)
        box.set_top(botBox, ll + zoneH)
        box.set_bottom(botBox, ll)
        box.set_extend(botBox, ext)
else
    if not na(topBox)
        box.delete(topBox), topBox := na
    if not na(botBox)
        box.delete(botBox), botBox := na

//â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ğŸ“Œ EQUILIBRIUM (EQ)
//â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
var line eqLine = na
var label eqLab = na

if showEQ
    if na(eqLine)
        eqLine := line.new(leftX, eq, rightX, eq, extend=ext, style=line.style_dashed)
    else
        line.set_xy1(eqLine, leftX, eq)
        line.set_xy2(eqLine, rightX, eq)
        line.set_extend(eqLine, ext)

    if showEqLbl and barstate.islast
        if not na(eqLab)
            label.delete(eqLab)
        eqLab := label.new(rightX, eq, "EQ",
            style=label.style_label_left,
            textcolor=color.white,
            color=color.new(color.gray, 60))
else
    if not na(eqLine)
        line.delete(eqLine), eqLine := na
    if not na(eqLab)
        label.delete(eqLab), eqLab := na

//â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ğŸ“Œ NIVELES CONFIRMADOS + EVENTOS (SMC)
//â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

// Nivel "confirmado" = el calculado en la barra anterior
hh_prev = hh[1]
ll_prev = ll[1]

// Detectar si la ventana (N velas) hizo un nuevo extremo (al cierre de la barra)
newHH = not na(hh_prev) and hh > hh_prev
newLL = not na(ll_prev) and ll < ll_prev

// Guardar el Ãºltimo nivel confirmado para medir toques/sweeps sin repaint
var float lastHH = na
var float lastLL = na

if barstate.isconfirmed
    if newHH
        lastHH := hh
    if newLL
        lastLL := ll

// Tolerancia de toque (% del nivel) - usa tu input touchTolPc
tolHH = na(lastHH) ? na : (lastHH * (touchTolPc / 100.0))
tolLL = na(lastLL) ? na : (lastLL * (touchTolPc / 100.0))

// "Toque" (simple): el precio llega al nivel (con tolerancia)
hitHH = not na(lastHH) and high >= (lastHH - tolHH)
hitLL = not na(lastLL) and low  <= (lastLL + tolLL)

// Sweep / Barrido de liquidez (SMC):
//  - Barrido arriba: mecha rompe HH y cierra por debajo (rechazo)
//  - Barrido abajo: mecha rompe LL y cierra por encima (rechazo)
sweepHH = not na(lastHH) and high > lastHH and close < lastHH
sweepLL = not na(lastLL) and low  < lastLL and close > lastLL

//â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ğŸ”” ALERTAS
//â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
alertcondition(alertOnNew and newHH, title="Nuevo HH (ventana N)", message="ğŸŸ¥ Nuevo HH creado en la ventana de N velas")
alertcondition(alertOnNew and newLL, title="Nuevo LL (ventana N)", message="ğŸŸ© Nuevo LL creado en la ventana de N velas")

alertcondition(alertOnHit and hitHH, title="Toque HH (Ãºltimo HH confirmado)", message="ğŸ“ Precio tocÃ³ el Ãºltimo HH confirmado")
alertcondition(alertOnHit and hitLL, title="Toque LL (Ãºltimo LL confirmado)", message="ğŸ“ Precio tocÃ³ el Ãºltimo LL confirmado")

alertcondition(sweepHH, title="Sweep HH (barrido liquidez arriba)", message="ğŸ§² Sweep arriba: mecha rompe HH y cierre vuelve debajo (posible trampa)")
alertcondition(sweepLL, title="Sweep LL (barrido liquidez abajo)", message="ğŸ§² Sweep abajo: mecha rompe LL y cierre vuelve encima (posible trampa)")

//â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ğŸ”” ALERTA GLOBAL CON MENSAJE DINÃMICO + SÃMBOLO
//â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

sendAll = newHH or newLL or hitHH or hitLL or sweepHH or sweepLL

eventMsg =
     newHH   ? "ğŸŸ¥ Nuevo HH"
  :  newLL   ? "ğŸŸ© Nuevo LL"
  :  sweepHH ? "ğŸ§² Sweep HH (barrido arriba)"
  :  sweepLL ? "ğŸ§² Sweep LL (barrido abajo)"
  :  hitHH   ? "ğŸ“ Toque HH"
  :  hitLL   ? "ğŸ“ Toque LL"
  :  "Evento SMC"

if sendAll and barstate.isconfirmed
    alert("ğŸ”” " + syminfo.ticker + " | " + eventMsg, alert.freq_once_per_bar_close)

//Siguentes pasos
// ğŸ”— Flujo SMC correcto (muy importante)

// Sweep (inducciÃ³n)

// Desplazamiento (impulso fuerte)

// BOS / CHOCH

// MitigaciÃ³n

// Entrada

// Tu indicador ya cubre el paso 1 de forma excelente.

// Si quieres, siguiente paso lÃ³gico:

// AÃ±adir BOS / CHOCH automÃ¡tico

// Filtrar alertas para solo sweeps + contexto vÃ¡lido

// Detectar falsos sweeps (ruido)