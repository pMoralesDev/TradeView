// This Pine Script¬Æ code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// ¬© pmoralesdev

//@version=6
strategy("ST_MM_000",
     overlay = true,
     initial_capital = 100000,
     pyramiding = 0,
     process_orders_on_close = true)

//‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// üìå INPUTS MEDIAS PRINCIPALES / ESTRUCTURA
//‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

group_main   = "üîπ Medias principales"
group_struct = "üîπ Medias de estructura"
group_signals = "üîπ Se√±ales estructura"
group_context = "üîπ Contexto / Distancia"
group_entries = "üîπ Entradas"
group_risk    = "üîπ Gesti√≥n de riesgo"
group_side    = "üîπ Lado de operaci√≥n"

// Medias principales (coherentes con MM_Distancia)
emaLen = input.int(50,  "Longitud EMA (r√°pida)", group = group_main)
smaLen = input.int(200, "Longitud SMA (lenta)",  group = group_main)

// Medias de estructura
showMa200 = input.bool(true,  "Mostrar MA 200", group = group_struct)
showMa100 = input.bool(true,  "Mostrar MA 100", group = group_struct)
showMa50  = input.bool(true,  "Mostrar MA  50", group = group_struct)
showMa20  = input.bool(true,  "Mostrar MA  20", group = group_struct)
useEMA    = input.bool(false, "Usar EMA en vez de SMA (estructura)", group = group_struct)

// Se√±ales de estructura
showPullbacks = input.bool(true, "Mostrar pullbacks a MA (solo visual)", group = group_signals)
pullbackLen   = input.int(1, "Tolerancia retest (n velas)", minval = 0, group = group_signals)

//‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// üìå INPUTS MM_DISTANCIA (CONTEXTO)
//‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

// Medias para distancia
emaLenDist = input.int(50,  "Longitud EMA distancia", group = "üîπ MEDIAS")
smaLenDist = input.int(200, "Longitud SMA distancia", group = "üîπ MEDIAS")

// Umbrales
lenNorm  = input.int(200, "Velas para normalizar", minval=10,   group = "üîπ UMBRALES")
umbralN  = input.float(0.6, "Umbral normalizado",  step=0.05,   group = "üîπ UMBRALES")
umbral_tend_fuerte = input.float(0.5, "Umbral Extremos",  step=0.05,   group = "üîπ UMBRALES")
umbral_tend_normal = input.float(0.3, "Umbral tendencia",  step=0.05,   group = "üîπ UMBRALES")
umbral_lateral = input.float(0.2, "Umbral lateral",  step=0.05,   group = "üîπ UMBRALES")

// Contadores
lenMediaDist   = input.int(50, "Velas tendencia",           minval=1, group = "üîπ CONTADORES")
lenSignWindow  = input.int(50, "Ventana cambios de signo",  minval=2, group = "üîπ CONTADORES")
maxSignChanges = input.int(3,  "M√°x cambios de signo",      minval=0, group = "üîπ CONTADORES")

// Velocidad
fastLen           = input.int(5,  "EMA MACD r√°pida",  minval=1, group = "üîπ VELOCIDAD")
slowLen           = input.int(20, "EMA MACD lenta",   minval=1, group = "üîπ VELOCIDAD")
strongMomentumThr = input.float(0.35, "Umbral velocidad", step=0.05, group = "üîπ VELOCIDAD")

// Impulso ‚Äì salida
exitImpThr      = input.float(0.25, "Fuerza impulso salida",      step=0.05, group = "üîπ IMPULSO")
exitConfirmBars = input.int(3,      "Velas confirmaci√≥n salida",  minval=1,  group = "üîπ IMPULSO")

//‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// üìå INPUTS CONTEXTO / ENTRADAS / RIESGO
//‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

// Filtro de contexto
modoContexto = input.string(
     "Fuerte+Normal",
     "Filtro de contexto",
     options = ["Solo fuerte", "Fuerte+Normal", "Incluir transici√≥n"],
     group = group_context)

// Entradas
useCrossEntry    = input.bool(true,  "Usar entradas por cruce EMA-SMA", group = group_entries)
usePullbackEntry = input.bool(true,  "Usar entradas por pullback a media", group = group_entries)

pullbackSource = input.string(
     "MA 20",
     "Media para pullback",
     options = ["MA 20","MA 50","MA 100","MA 200","EMA principal","SMA principal"],
     group = group_entries)

// Gesti√≥n de riesgo
stPerc = input.float(0.4, "Stop (%) desde entrada", step=0.1, group = group_risk)
tpRR   = input.float(2.0, "Take Profit (m√∫ltiplo de R)", step=0.1, group = group_risk)
useDynamicExit = input.bool(true, "Usar salida por p√©rdida de impulso / lateral", group = group_risk)

// Lado de operaci√≥n
sideFilter = input.string(
     "Ambos",
     "Lados a operar",
     options = ["Ambos","Solo largos","Solo cortos"],
     group = group_side)

//‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// üìå C√ÅLCULO MEDIAS PRINCIPALES Y ESTRUCTURA
//‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

emaMain = ta.ema(close, emaLen)
smaMain = ta.sma(close, smaLen)

ma200 = useEMA ? ta.ema(close, 200) : ta.sma(close, 200)
ma100 = useEMA ? ta.ema(close, 100) : ta.sma(close, 100)
ma50  = useEMA ? ta.ema(close,  50) : ta.sma(close,  50)
ma20  = useEMA ? ta.ema(close,  20) : ta.sma(close,  20)

// Stacking estructura
bullStack = close > ma20 and ma20 > ma50 and ma50 > ma100
bearStack = close < ma20 and ma20 < ma50 and ma50 < ma100

// Cruces EMA-SMA principales
bullCross = ta.crossover(emaMain, smaMain)
bearCross = ta.crossunder(emaMain, smaMain)

//‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// üìå MM_DISTANCIA ‚Äì C√ÅLCULO
//‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

// Medias para distancia (pueden ser distintas, pero por defecto iguales)
emaDist = ta.ema(close, emaLenDist)
smaDist = ta.sma(close, smaLenDist)
distPct = (emaDist - smaDist) / smaDist * 100

// Umbral din√°mico-normalizado
maxAbsDist    = ta.highest(math.abs(distPct), lenNorm)
distNorm      = maxAbsDist != 0.0 ? distPct / maxAbsDist : 0.0
distNormMedia = ta.sma(distNorm, lenMediaDist)

// Estabilidad de signo
signNow  = distNormMedia > 0 ? 1 : distNormMedia < 0 ? -1 : 0
signPrev = distNormMedia[1] > 0 ? 1 : distNormMedia[1] < 0 ? -1 : 0
signChanged = signNow != signPrev

signChangeSeries  = signChanged ? 1.0 : 0.0
signChangesLastN  = math.sum(signChangeSeries, lenSignWindow)
tendEstable       = signChangesLastN <= maxSignChanges

// Velocidad
distFast = ta.ema(distNorm, fastLen)
distSlow = ta.ema(distNorm, slowLen)

// Sem√°foro de tendencia
absMedia = math.abs(distNormMedia)
absNorm  = math.abs(distNorm)

// 1. V√≠a cl√°sica
tendFuerte_clasica = absMedia >= umbral_tend_fuerte and tendEstable
tendNormal_clasica = absMedia >= umbral_tend_normal and absMedia < umbral_tend_fuerte and tendEstable

// 2. V√≠a r√°pida
tendNormal_rapida = (distFast > distSlow) and tendEstable and absNorm >= umbral_lateral and absMedia < umbral_tend_normal
tendFuerte_rapida = (distFast > distSlow) and tendEstable and absNorm >= strongMomentumThr 

// 3. Combinaci√≥n
esTendFuerte_preExit = tendFuerte_clasica or tendFuerte_rapida
esTendNormal_preExit = tendNormal_clasica or tendNormal_rapida

// 4. Salida r√°pida de tendencia
exitRaw      = (distFast < distSlow) and (absNorm < exitImpThr)
exitCount    = math.sum(exitRaw ? 1.0 : 0.0, exitConfirmBars)
salidaRapida = exitCount == exitConfirmBars

// Condicionales finales
esTendFuerte = esTendFuerte_preExit and not salidaRapida
esTendNormal = esTendNormal_preExit and not salidaRapida
esLateral    = absMedia < umbral_lateral
esTransicion = not esTendFuerte and not esTendNormal and not esLateral

// Direcci√≥n de la tendencia por distancia
tendUp   = distNormMedia > 0
tendDown = distNormMedia < 0

// Filtro de contexto seg√∫n modo
allowStrong  = esTendFuerte
allowNormal  = (modoContexto == "Fuerte+Normal" or modoContexto == "Incluir transici√≥n") and esTendNormal
allowTrans   = (modoContexto == "Incluir transici√≥n") and esTransicion

okBaseTrend = (allowStrong or allowNormal or allowTrans) and not esLateral

okTrendLong  = okBaseTrend and tendUp
okTrendShort = okBaseTrend and tendDown

//‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// üìå L√ìGICA ENTRADAS (CRUCE / PULLBACK)
//‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

// Seleccionamos media para pullback
maPullback =
     pullbackSource == "MA 20"        ? ma20 :
     pullbackSource == "MA 50"        ? ma50 :
     pullbackSource == "MA 100"       ? ma100 :
     pullbackSource == "MA 200"       ? ma200 :
     pullbackSource == "EMA principal"? emaMain :
     smaMain  // "SMA principal"

// Pullback alcista: precio se ha acercado/penetrado la media en √∫ltimas N velas y cierra por encima
condPullbackLong =
     bullStack and okTrendLong and
     ta.lowest(low, pullbackLen + 1) <= maPullback and
     close > maPullback

// Pullback bajista
condPullbackShort =
     bearStack and okTrendShort and
     ta.highest(high, pullbackLen + 1) >= maPullback and
     close < maPullback

// Se√±ales finales de entrada
longSignal =
     ( (useCrossEntry and bullCross) or (usePullbackEntry and condPullbackLong) ) and
     okTrendLong and bullStack

shortSignal =
     ( (useCrossEntry and bearCross) or (usePullbackEntry and condPullbackShort) ) and
     okTrendShort and bearStack

canLong  = sideFilter != "Solo cortos"
canShort = sideFilter != "Solo largos"

//‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// üìå √ìRDENES DE ENTRADA (CON FLIP)
//‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

if longSignal and canLong
    // Con pyramiding = 0, una nueva entrada long cierra el short previo (flip)
    strategy.entry("Long", strategy.long)

if shortSignal and canShort
    strategy.entry("Short", strategy.short)

//‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// üìå STOP LOSS Y TAKE PROFIT
//‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

if strategy.position_size > 0
    longStop = strategy.position_avg_price * (1 - stPerc / 100.0)
    longTake = strategy.position_avg_price * (1 + stPerc / 100.0 * tpRR)
    strategy.exit("Long TP/ST", from_entry = "Long", stop = longStop, limit = longTake)

if strategy.position_size < 0
    shortStop = strategy.position_avg_price * (1 + stPerc / 100.0)
    shortTake = strategy.position_avg_price * (1 - stPerc / 100.0 * tpRR)
    strategy.exit("Short TP/ST", from_entry = "Short", stop = shortStop, limit = shortTake)

//‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// üìå SALIDA DIN√ÅMICA POR IMPULSO / LATERAL
//‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

exitCond = useDynamicExit and (salidaRapida or esLateral)

if exitCond and strategy.position_size > 0
    strategy.close("Long")

if exitCond and strategy.position_size < 0
    strategy.close("Short")

//‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// üìå PLOTS VISUALES (MA + STACKING)
//‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

// Opcional: marcar pullbacks visualmente
//plotshape(showPullbacks and condPullbackLong,  title = "Pullback Long",  style = shape.triangleup,   location = location.belowbar, color = color.new(color.lime, 0), size = size.tiny)
//plotshape(showPullbacks and condPullbackShort, title = "Pullback Short", style = shape.triangledown, location = location.abovebar, color = color.new(color.red,  0), size = size.tiny)
