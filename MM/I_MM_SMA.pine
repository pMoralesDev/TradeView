// This Pine ScriptÂ® code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// Â© pmoralesdev

//@version=6
indicator("I_MM_OnTrade_SMA_AlertsOnly", overlay = true, max_labels_count = 500)

//â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ğŸ“Œ INPUTS
//â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
group_medias = "ğŸ“Œ Medias"
lenSmaEntry  = input.int(100, "Longitud SMA entrada",           minval = 1, group = group_medias)
lenSmaFast   = input.int(25,  "Longitud SMA rÃ¡pida (SMA25)",    minval = 1, group = group_medias)
lenSmaSlow   = input.int(50,  "Longitud SMA lenta (SMA50)",     minval = 1, group = group_medias)

group_sl = "ğŸ“Œ Stop Loss"
slLookback = input.int(5, "Velas para calcular SL", minval = 1, group = group_sl)

group_slope = "ğŸ“Œ Filtro pendiente SMA25"
slopeLen    = input.int(20,     "Velas para calcular pendiente", minval = 1, group = group_slope)
slopeThrPct = input.float(0.1, "Pendiente mÃ­nima (%)", step = 0.01, group = group_slope)

group_sess = "ğŸ“Œ Horario operativa"
tradingSession = input.session("0800-2200", "Horario (HHMM-HHMM)", group = group_sess)

//â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ğŸ“Œ CÃLCULO DE MEDIAS
//â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
smaEntry = ta.sma(close, lenSmaEntry)   // SMA100 por defecto
smaFast  = ta.sma(close, lenSmaFast)    // SMA25 por defecto
smaSlow  = ta.sma(close, lenSmaSlow)    // SMA50 por defecto

plot(smaEntry, "SMA entrada (100)", color = color.orange, linewidth = 2)
plot(smaFast,  "SMA rÃ¡pida (25)",   color = color.new(color.teal, 0))
plot(smaSlow,  "SMA lenta (50)",    color = color.new(color.blue, 0))

//â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ğŸ“Œ HORARIO DE OPERATIVA
//â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
inSession = not na(time(timeframe.period, tradingSession))

// Bar de apertura de sesiÃ³n: pasa de fuera a dentro
sessionOpen = inSession and not inSession[1]
// Bar de cierre de sesiÃ³n: pasa de dentro a fuera
sessionClose = not inSession and inSession[1]

//â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ğŸ“Œ CONDICIONES DE ENTRADA (precioâ€“SMA100)
//â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
priceCrossUp   = ta.crossover(close, smaEntry)   // Precio cruza al alza la SMA100
priceCrossDown = ta.crossunder(close, smaEntry)  // Precio cruza a la baja la SMA100

// Stop Loss dinÃ¡mico (Ãºltimas N velas)
slLong  = ta.lowest(low,  slLookback)   // SL para BUY â†’ mÃ­nimo Ãºltimas N velas
slShort = ta.highest(high, slLookback)  // SL para SELL â†’ mÃ¡ximo Ãºltimas N velas

// Pendiente SMA25 en %
float slopeFast = 0.0
if slopeLen > 0 and not na(smaFast[slopeLen])
    slopeFast := (smaFast - smaFast[slopeLen]) / smaFast[slopeLen] * 100.0
else
    slopeFast := 0.0

slopeOkLong  = slopeFast >  slopeThrPct    // Solo BUY si pendiente positiva suficiente
slopeOkShort = slopeFast < -slopeThrPct    // Solo SELL si pendiente negativa suficiente

//TODO: AÃ±adir filtro de volumen, velocidad, distancia... slopeFast pendiente
enterLong  = priceCrossUp   and inSession
enterShort = priceCrossDown and inSession

//â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ğŸ“Œ CRUCES SMA25â€“SMA50 (ALERTAS DE TP / CIERRE)
//â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
smaCrossUp   = ta.crossover(smaFast, smaSlow)   // SMA25 cruza al alza SMA50
smaCrossDown = ta.crossunder(smaFast, smaSlow)  // SMA25 cruza a la baja SMA50

closeSignal = (smaCrossUp or smaCrossDown) and inSession

// Precio TP sugerido = close en el cruce SMA25â€“SMA50
tpPrice = close

//â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ğŸ“Œ LÃNEA DE SL GRÃFICA (Ãºltima entrada)
//â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
var float slLine = na

if enterLong
    slLine := slLong
else if enterShort
    slLine := slShort
else if closeSignal
    slLine := na

//â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ğŸ“Œ ALERTAS
//â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
activo = syminfo.ticker

// Mensajes entrada
longMsg  = "ğŸ“ˆ"  + activo + "\nST:" + str.tostring(slLong,  format.mintick)
shortMsg = "ğŸ“‰" + activo + "\nST:" + str.tostring(slShort, format.mintick)

// Mensaje cruce SMA25â€“SMA50 (posible TP/cierre)
closeMsg = "ğŸ¯" + activo + "\nTP:" + str.tostring(tpPrice, format.mintick)

// Mensaje de apertura de sesiÃ³n: alcista / bajista segÃºn SMA100
string openMsg = ""
if close > smaEntry
    openMsg := "ğŸ“ˆ " + activo + ": tendencia alcista"
else
    openMsg := "ğŸ“‰ " + activo + ": tendencia bajista"

// Mensaje de cierre de sesiÃ³n (buenas noches)
string closeDayMsg = "Cierre de sesiÃ³n " + activo + ": buenas noches"

// EnvÃ­o de alertas
if enterLong
    alert(longMsg,  alert.freq_once_per_bar_close)

if enterShort
    alert(shortMsg, alert.freq_once_per_bar_close)

if closeSignal
    alert(closeMsg, alert.freq_once_per_bar_close)

if sessionOpen
    alert(openMsg, alert.freq_once_per_bar_close)

if sessionClose
    alert(closeDayMsg, alert.freq_once_per_bar_close)

//â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ğŸ“Œ SEÃ‘ALES VISUALES EN EL GRÃFICO
//â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

// Flechitas en entradas
plotshape(enterLong, title="Entrada BUY", style=shape.triangleup, location=location.belowbar, color=color.lime, size=size.small, text="BUY")
plotshape(enterShort, title="Entrada SELL", style=shape.triangledown, location=location.abovebar, color=color.red, size=size.small, text="SELL")

// LÃ­nea horizontal del Stop Loss de la Ãºltima seÃ±al
//plot(slLine, title="Stop Loss activo", color=color.red, linewidth=1, style=plot.style_linebr)

// Punto/cross en cada cruce SMA25â€“SMA50 (TP)
plot(closeSignal ? tpPrice : na, title="Cruce SMA25-50 (TP)", style=plot.style_cross, linewidth=5, color=color.yellow)
